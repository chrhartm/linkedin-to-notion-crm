<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Personal CRM</h1>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="alert alert-info" role="alert">
            Connecting to server...
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Sync LinkedIn Contacts</h5>
                <form id="syncForm" action="/sync" method="post" enctype="multipart/form-data" class="mb-4">
                    <input type="hidden" id="socket_id" name="socket_id" value="">
                    <div class="mb-3">
                        <label for="notion_token" class="form-label">Notion Token</label>
                        <input type="password" class="form-control" id="notion_token" name="notion_token" required>
                    </div>
                    <div class="mb-3">
                        <label for="notion_database_id" class="form-label">Notion Database ID</label>
                        <input type="text" class="form-control" id="notion_database_id" name="notion_database_id" required>
                    </div>
                    <div class="mb-3">
                        <label for="linkedin_file" class="form-label">LinkedIn Contacts CSV</label>
                        <input type="file" class="form-control" id="linkedin_file" name="linkedin_file" accept=".csv" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="syncButton">Sync Contacts</button>
                </form>

                <!-- Progress Note -->
                <div class="alert alert-info mb-3" role="alert">
                    <h6 class="alert-heading mb-2">About the Sync Process:</h6>
                    <ul class="mb-0">
                        <li>The sync process may take several minutes depending on the number of contacts</li>
                        <li>Please keep this window open until the sync is complete</li>
                        <li>The progress bar might freeze but the syncing will continue in the background</li>
                    </ul>
                </div>

                <!-- Progress Section -->
                <div id="progressSection" style="display: none;">
                    <div class="progress mb-3">
                        <div id="syncProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" 
                             aria-valuemax="100">0%</div>
                    </div>
                    <p id="syncStatus" class="text-muted mb-2"></p>
                    <p id="currentContact" class="text-muted small mb-3"></p>
                    <div id="errorDetails" class="alert alert-danger" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="alert-heading mb-1"></h6>
                                <p class="mb-0 error-message"></p>
                                <small class="error-details"></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- How To Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title mb-4">How To Use</h2>
                
                <!-- LinkedIn Instructions -->
                <div class="mb-4">
                    <h3>1. Export LinkedIn Contacts</h3>
                    <div class="mb-4">
                        <p>Follow these steps to export your LinkedIn connections:</p>
                        <ol class="list-group list-group-numbered mb-3">
                            <li class="list-group-item">Go to LinkedIn.com and sign in</li>
                            <li class="list-group-item">Click on 'Me'</li>
                            <li class="list-group-item">Click on 'Settings & Privacy'</li>
                            <li class="list-group-item">Click on 'Data Privacy'</li>
                            <li class="list-group-item">Select 'Get a copy of your data'</li>
                            <li class="list-group-item">Select 'Connections' and request a download</li>
                        </ol>
                    </div>
                    <div class="text-center">
                        <img src="/howto-linkedin.png" alt="LinkedIn Export Instructions" class="img-fluid rounded shadow-sm mb-3" style="max-width: 100%; height: auto;">
                    </div>
                </div>

                <!-- Notion Instructions -->
                <div class="mb-4">
                    <h3>2. Set Up Notion Integration</h3>
                    <div class="mb-4">
                        <p>Configure your Notion integration and get your credentials:</p>
                        <ol class="list-group list-group-numbered mb-3">
                            <li class="list-group-item">Go to notion.so/my-integrations</li>
                            <li class="list-group-item">Click 'Create new integration'</li>
                            <li class="list-group-item">Name your integration</li>
                            <li class="list-group-item">Copy the Integration Token</li>
                            <li class="list-group-item">Create a new database in Notion</li>
                            <li class="list-group-item">Copy the database ID from the URL</li>
                            <li class="list-group-item">Open the settings of the Database page on the top left three dots</li>
                            <li class="list-group-item">Select 'Connect to' and your integration</li>
                        </ol>
                    </div>
                    <div class="text-center">
                        <img src="/howto-notion.png" alt="Notion Setup Instructions" class="img-fluid rounded shadow-sm mb-3" style="max-width: 100%; height: auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Wait for DOM content to be fully loaded before initializing
        document.addEventListener('DOMContentLoaded', function() {
            let retryCount = 0;
            const MAX_RETRIES = 5;
            const RETRY_DELAY = 2000;
            let socket = null;

            // Function to initialize UI elements with error handling
            function initializeUI() {
                const elements = {};
                const ids = [
                    'connectionStatus',
                    'progressSection',
                    'syncProgress',
                    'syncStatus',
                    'currentContact',
                    'errorDetails',
                    'syncForm',
                    'syncButton',
                    'socket_id'
                ];

                ids.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        elements[id] = element;
                    } else {
                        console.warn(`Element with id '${id}' not found`);
                    }
                });

                return elements;
            }

            // Initialize UI elements
            const elements = initializeUI();

            // Function to initialize Socket.IO with retry mechanism
            function initializeSocket() {
                try {
                    if (socket) {
                        socket.close();
                        socket = null;
                    }

                    socket = io({
                        reconnection: true,
                        reconnectionAttempts: MAX_RETRIES,
                        reconnectionDelay: RETRY_DELAY,
                        reconnectionDelayMax: RETRY_DELAY * 2,
                        timeout: 20000,
                        transports: ['polling', 'websocket'],
                        upgrade: true,
                        forceNew: true,
                        path: '/socket.io/'
                    });

                    setupSocketEventHandlers();
                    return true;
                } catch (error) {
                    console.error('Socket initialization error:', error);
                    handleConnectionError(error);
                    return false;
                }
            }

            // Function to update connection status
            function updateConnectionStatus(type, message) {
                const connectionStatus = elements.connectionStatus;
                if (!connectionStatus) return;

                const statusClasses = {
                    success: 'alert-success',
                    warning: 'alert-warning',
                    error: 'alert-danger',
                    info: 'alert-info'
                };

                connectionStatus.className = `alert ${statusClasses[type] || 'alert-info'}`;
                connectionStatus.textContent = message;
                connectionStatus.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        if (connectionStatus.style) {
                            connectionStatus.style.display = 'none';
                        }
                    }, 3000);
                }
            }

            // Function to handle connection errors
            function handleConnectionError(error) {
                console.error('Connection error:', error);
                if (retryCount < MAX_RETRIES) {
                    retryCount++;
                    updateConnectionStatus('warning', `Connection error. Retry attempt ${retryCount}/${MAX_RETRIES}...`);
                    setTimeout(initializeSocket, RETRY_DELAY);
                } else {
                    updateConnectionStatus('error', 'Failed to establish connection after multiple attempts');
                }
            }

            // Function to set up socket event handlers
            function setupSocketEventHandlers() {
                if (!socket) return;

                socket.on('connect', () => {
                    retryCount = 0;
                    const socketIdInput = elements.socket_id;
                    if (socketIdInput) {
                        socketIdInput.value = socket.id;
                    }
                    updateConnectionStatus('success', 'Connected to server');
                });

                socket.on('disconnect', () => {
                    updateConnectionStatus('warning', 'Disconnected from server. Attempting to reconnect...');
                });

                socket.on('connect_error', handleConnectionError);
                socket.on('error', handleConnectionError);
                socket.on('sync_progress', handleSyncProgress);
            }

            // Function to handle sync progress
            function handleSyncProgress(data) {
                const progressSection = elements.progressSection;
                if (!progressSection) return;

                try {
                    progressSection.style.display = 'block';

                    if (data.status === 'processing') {
                        updateProcessingProgress(data);
                    } else if (data.status === 'completed') {
                        handleCompletion();
                    } else if (data.status === 'error') {
                        handleError(data);
                    }
                } catch (error) {
                    console.error('Error handling sync progress:', error);
                }
            }

            // Function to update processing progress
            function updateProcessingProgress(data) {
                const { syncProgress, syncStatus, currentContact } = elements;
                if (!syncProgress || !syncStatus) return;

                try {
                    syncProgress.classList.remove('bg-danger', 'bg-warning', 'bg-success');
                    syncProgress.classList.add('bg-primary');

                    if (data.total && data.current) {
                        const percentage = Math.round((data.current / data.total) * 100);
                        syncProgress.style.width = `${percentage}%`;
                        syncProgress.textContent = `${percentage}%`;
                        syncProgress.setAttribute('aria-valuenow', percentage);
                    }

                    syncStatus.className = 'text-muted mb-2';
                    syncStatus.textContent = data.message || 'Processing...';

                    if (data.contact && currentContact) {
                        currentContact.textContent = `Current contact: ${data.contact}`;
                        currentContact.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error updating progress:', error);
                }
            }

            // Function to handle completion
            function handleCompletion() {
                const { syncProgress, syncStatus, currentContact, syncButton, errorDetails } = elements;
                if (!syncProgress || !syncStatus) return;

                try {
                    syncProgress.classList.remove('bg-primary', 'bg-warning', 'bg-danger');
                    syncProgress.classList.add('bg-success');
                    syncStatus.className = 'text-success mb-2';
                    syncStatus.textContent = 'Sync completed successfully!';

                    if (currentContact) {
                        currentContact.style.display = 'none';
                    }
                    if (syncButton) {
                        syncButton.disabled = false;
                    }
                    if (errorDetails) {
                        errorDetails.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error handling completion:', error);
                }
            }

            // Function to handle errors
            function handleError(error) {
                const { errorDetails, syncProgress, syncStatus, syncButton } = elements;
                if (!errorDetails) return;

                try {
                    if (syncProgress) {
                        syncProgress.classList.remove('bg-primary', 'bg-warning', 'bg-success');
                        syncProgress.classList.add('bg-danger');
                    }

                    if (syncStatus) {
                        syncStatus.className = 'text-danger mb-2';
                        syncStatus.textContent = error.message || 'An error occurred';
                    }

                    const updateElement = (selector, content) => {
                        const element = errorDetails.querySelector(selector);
                        if (element) {
                            element.textContent = content || '';
                        }
                    };

                    updateElement('.alert-heading', error.type || 'Error');
                    updateElement('.error-message', error.message || 'An error occurred');
                    updateElement('.error-details', error.details || '');

                    errorDetails.style.display = 'block';
                    if (syncButton) {
                        syncButton.disabled = false;
                    }
                } catch (e) {
                    console.error('Error handling error display:', e);
                }
            }

            // Initialize form submission handler
            const syncForm = elements.syncForm;
            if (syncForm) {
                syncForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!socket || !socket.connected) {
                        handleError({
                            type: 'CONNECTION_ERROR',
                            message: 'Not connected to server',
                            details: 'Please wait for connection to be established'
                        });
                        return;
                    }

                    const syncButton = elements.syncButton;
                    const progressSection = elements.progressSection;

                    try {
                        if (syncButton) {
                            syncButton.disabled = true;
                        }
                        if (progressSection) {
                            progressSection.style.display = 'block';
                        }

                        resetProgress();

                        const formData = new FormData(syncForm);
                        const response = await fetch('/sync', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            throw { ...data, status_code: response.status };
                        }
                        if (data.status !== 'success') {
                            throw new Error(data.message || 'Unknown error occurred');
                        }
                    } catch (error) {
                        handleError({
                            type: error.error_type || 'SYNC_ERROR',
                            message: error.message || 'Error during sync process',
                            details: error.details || 'Please try again'
                        });
                    }
                });
            }

            // Function to reset progress
            function resetProgress() {
                const updates = {
                    syncProgress: { width: '0%', text: '0%', classes: ['bg-primary'] },
                    syncStatus: { text: 'Starting sync process...', classes: ['text-muted', 'mb-2'] },
                    currentContact: { display: 'none' },
                    errorDetails: { display: 'none' }
                };

                Object.entries(updates).forEach(([key, update]) => {
                    const element = elements[key];
                    if (!element) return;

                    try {
                        if (update.width) element.style.width = update.width;
                        if (update.text) element.textContent = update.text;
                        if (update.display) element.style.display = update.display;
                        if (update.classes) {
                            element.className = '';
                            update.classes.forEach(cls => element.classList.add(cls));
                        }
                    } catch (error) {
                        console.error(`Error resetting ${key}:`, error);
                    }
                });
            }

            // Initialize Socket.IO connection
            initializeSocket();

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (socket && socket.connected) {
                    socket.close();
                }
            });
        });
    </script>
</body>
</html>
